{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@prippp/synopsis/webpack/bootstrap","webpack://@prippp/synopsis/webpack/runtime/compat get default export","webpack://@prippp/synopsis/webpack/runtime/define property getters","webpack://@prippp/synopsis/webpack/runtime/hasOwnProperty shorthand","webpack://@prippp/synopsis/external root \"flarum.core.compat['forum/app']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['common/extend']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['common/utils/string']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['tags/models/Tag']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['common/Model']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['forum/components/SearchPage']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['forum/components/SettingsPage']\"","webpack://@prippp/synopsis/external root \"flarum.core.compat['common/utils/Stream']\"","webpack://@prippp/synopsis/./src/forum/index.ts","webpack://@prippp/synopsis/./src/forum/addSummaryExcerpt.tsx","webpack://@prippp/synopsis/./src/forum/addUserPreference.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/string'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/models/Tag'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/Model'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/SearchPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/SettingsPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/Stream'];","import app from 'flarum/forum/app';\n\nimport addSummaryExcerpt from './addSummaryExcerpt';\nimport addUserPreference from './addUserPreference';\n\napp.initializers.add('prippp-synopsis', () => {\n  addSummaryExcerpt();\n  addUserPreference();\n});","import { extend } from 'flarum/common/extend';\nimport app from 'flarum/forum/app';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport { truncate } from 'flarum/common/utils/string';\nimport ItemList from 'flarum/common/utils/ItemList';\nimport Tag from 'flarum/tags/models/Tag';\nimport Model from 'flarum/common/Model';\nimport type Mithril from 'mithril';\nimport IndexPage from 'flarum/forum/components/IndexPage';\nimport SearchPage from 'flarum/forum/components/SearchPage'; // 引入 SearchPage 组件\n\n\nexport default function addSummaryExcerpt() {\n\n    /// 设置搜索页面\n    if (typeof SearchPage !== 'undefined') {\n        extend(SearchPage.prototype, 'viewItems', function (items: ItemList<Mithril.Children>) {\n            extendDiscussionListItem();\n        });\n    }\n\n    // 继续你的代码...\n    if (app.initializers.has('flarum-tags')) {\n        Tag.prototype.richExcerpts = Model.attribute('richExcerpts');\n        Tag.prototype.excerptLength = Model.attribute('excerptLength');\n    }\n\n    function extendDiscussionListItem() {\n\n        extend(DiscussionListItem.prototype, 'infoItems', function (items: ItemList<Mithril.Children>) {\n            const discussion = this.attrs.discussion;\n\n            if (app.session.user && !app.session.user.preferences().showSynopsisExcerpts) { return; }\n\n            const tags = discussion.tags();\n            let tag;\n            if (tags) { tag = tags[tags.length - 1]; }\n\n            const excerptPost = app.forum.attribute('synopsis.excerpt_type') === 'first' ? discussion.firstPost() : discussion.lastPost();\n            const excerptLength = typeof tag?.excerptLength() === 'number' ? tag?.excerptLength() : app.forum.attribute('synopsis.excerpt_length');\n            // 这里是富文本判断  下面直接使用了\n            const richExcerpt = typeof tag?.richExcerpts() === 'number' ? tag?.richExcerpts() : app.forum.attribute('synopsis.rich_excerpts');\n\n            const onMobile = true;\n\n            if (excerptLength === 0) { return; }\n\n            if (!excerptPost?.contentHtml?.()) return;\n            // console.log(\"源文件1：\",excerptPost)\n            // console.log(\"源文件2：\",excerptPost.contentHtml())\n\n            const contentWithoutLinks = excerptPost.contentHtml().replace(/https:\\/\\/(pan|baidu)\\.[^\\s]+/g, '进入详情查看');\n\n            // 调用字符串解析方法，将图片和文本分开处理\n            const modifiedHtml = restructureHtmlWithStrings(contentWithoutLinks);\n\n            \n            const content = m.trust(truncate(modifiedHtml, excerptLength));\n\n            // console.log(\"源文件content：\",content)\n            if (excerptPost) {\n                const noImgs = <div className=\"custom-i1\"></div>;\n                const hasImages = /<img[^>]*>/i.test(excerptPost.contentHtml());\n                // console.log(excerptPost)\n                // 如果没有图片，添加一个自定义的 noImgs 元素\n                if (!hasImages) {\n                    const noImgs = <div className=\"custom-excerptI\"></div>; // 您可以自定义内容\n                    items.add('excerptI', noImgs, 600); // 设置优先级为 400，确保在摘要之后\n                }\n\n                const excerpt = <div className=\"custom-excerpt\">{content}</div>;\n                items.add(onMobile ? 'excerptM' : 'excerpt', excerpt, 500);\n\n                if (items.has('tags')) {\n                    items.setPriority('tags', 70);\n                }\n\n                const excerpt2 = <div className=\"custom-excerpt2\"></div>;\n                items.add('excerptMC', excerpt2, 60);\n                if (items.has('terminalPost')) {\n                    items.setPriority('terminalPost', 50);\n                }\n                if (items.has('discussion-views')) {\n                    items.setPriority('discussion-views', 0);\n                }\n            }\n        });\n    }\n\n    // 初始扩展调用\n    extendDiscussionListItem();\n}\n\n// 解析和处理 HTML 的函数，结合上面的字符串解析方法\nfunction restructureHtmlWithStrings(htmlString) {\n    // 提取第一个 <p> 标签中的图片内容\n    const imgPattern = /<p>(<img[^>]*>.*?<\\/p>)/i;\n    const imageContent = htmlString.match(imgPattern) ? htmlString.match(imgPattern)[1] : ''; // 提取出包含图片的部分\n\n    // 提取图片之后的所有内容\n    const restContent = htmlString.replace(imgPattern, ''); // 删除图片部分，保留剩下的内容\n\n    // 为图片部分添加 class\n    const imageWithClass = imageContent ? `<div class=\"image-container\">${imageContent}</div>` : '';\n\n    // 为其余内容添加 class\n    const contentWithClass = `<div class=\"content-container\">${restContent}</div>`;\n\n    // 合并并返回新的结构\n    return imageWithClass + contentWithClass;\n}\n\n// function restructureHtmlWithStrings(htmlString) {\n//     // 提取第一个 <p> 标签中的图片内容\n//     const imgPattern = /<p>(<img[^>]*>.*?<\\/p>)/i;\n//     let imageContent = htmlString.match(imgPattern) ? htmlString.match(imgPattern)[1] : ''; // 提取出包含图片的部分\n\n//     // 给第一个 img 标签添加 class\n//     if (imageContent) {\n//         imageContent = imageContent.replace('<img', '<img class=\"first-image-class\"'); // 给第一个 <img> 标签添加 class\n//     }\n\n//     // 提取图片之后的所有内容\n//     const restContent = htmlString.replace(imgPattern, ''); // 删除图片部分，保留剩下的内容\n\n//     // 为图片部分添加 class\n//     const imageWithClass = imageContent ? `<div class=\"image-container\">${imageContent}</div>` : '';\n\n//     // 为其余内容添加 class\n//     const contentWithClass = `<div class=\"content-container\">${restContent}</div>`;\n\n//     // 合并并返回新的结构\n//     return imageWithClass + contentWithClass;\n// }","import type Mithril from 'mithril';\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport SettingsPage from 'flarum/forum/components/SettingsPage';\nimport FieldSet from 'flarum/common/components/FieldSet';\nimport ItemList from 'flarum/common/utils/ItemList';\nimport Switch from 'flarum/common/components/Switch';\nimport Stream from 'flarum/common/utils/Stream';\n\nexport default function () {\n  extend(SettingsPage.prototype, 'oninit', function () {\n    this.showSynopsisExcerpts = Stream(this.user.preferences().showSynopsisExcerpts);\n    this.showSynopsisExcerptsOnMobile = Stream(this.user.preferences().showSynopsisExcerptsOnMobile);\n  });\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","app","add","extendDiscussionListItem","extend","DiscussionListItem","items","_tag","_tag2","_tag3","_tag4","discussion","this","attrs","user","preferences","showSynopsisExcerpts","tag","tags","length","excerptPost","attribute","firstPost","lastPost","excerptLength","richExcerpts","contentHtml","htmlString","imgPattern","imageContent","modifiedHtml","replace","match","content","m","trust","truncate","className","test","noImgs","excerpt","has","setPriority","excerpt2","SearchPage","Tag","Model","addSummaryExcerpt","SettingsPage","Stream","showSynopsisExcerptsOnMobile"],"sourceRoot":""}